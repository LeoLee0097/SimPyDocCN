# 时间调度

本文旨在加深你对 SimPy 中时间流逝方式以及事件调度和处理方式的理解。

## 什么是时间？

时间本身并不容易 grasped. 维基百科是这样描述的：

> 「时间是存在和事件在明显不可逆的序列中从过去通过现在到未来的无限持续进展。时间是用于对事件进行排序、比较事件持续时间或间隔以及量化物质现实或意识体验中数量变化率的各种测量中的一个组成部分。时间常被称为第四维度，与三个空间维度一起。」

## 时间的问题出在哪里？

通常，在现实世界中发生的事件（在现实世界中）似乎“同时”发生，而实际上它们发生在略有不同的时间。这里有一个明显的例子：Alice 和 Bob 的生日在同一天。如果你的时间尺度是天，那么两个生日事件就同时发生。如果你将时钟的分辨率提高到分钟，你可能会发现 Alice 其实在凌晨 0:42 出生，而 Bob 在 11:14 出生，两个事件之间有相当大的时间差。

在计算机上进行仿真也会遇到类似的问题。整数（和浮点数）是离散数字，它们之间有很多空白。因此，现实世界中按顺序发生的事件（例如，在 _t_ 1 = 0.1 和 _t_ 2 = 0.2）如果映射到整数尺度上（例如，在 _t_ = 0），可能会同时发生。

另一方面，SimPy（像大多数仿真框架一样）是一个单线程的、确定性的库。它按顺序处理事件 - 一个接一个。如果两个事件被安排在同一时间，那么先被安排的事件也会先被处理（先进先出）。

这对你来说非常重要。在你建模/仿真的世界中，进程可能“并行”运行，但当仿真在你的 CPU 上运行时，所有事件都是顺序和确定性地处理的。如果你多次运行仿真（并且你没有使用 `random`），你将始终得到相同的结果。

所以请记住以下几点：

- 在现实世界中，通常没有真正的“同时”。
- 时间尺度的离散化可能使事件看起来“同时”发生。
- SimPy 按顺序处理事件，即使它们具有相同的“时间”。

## SimPy 事件与时间

在继续之前，让我们回顾一下事件可能处于的状态（详情请参阅事件）：

- 未触发：未被事件队列知晓
- 已触发：安排在时间 _t_ 并插入到事件队列中
- 已处理：从事件队列中移除

SimPy 的事件队列实现为一个堆队列：「堆是二叉树，其中每个父节点的值小于或等于其任何子节点的值。」因此，如果我们以元组形式（_t_, event）（其中 _t_ 是预定时间）插入事件，那么根据定义，队列中的第一个元素始终是 _t_ 最小的那个，也是下一个要处理的元素。

然而，如果两个事件被安排在同一时间，仅存储（_t_, event）元组将无法正常工作，因为事件是不可比较的。为了解决这个问题，我们还存储了一个严格递增的事件 ID：（_t_, eid, event）。这样，如果两个事件被安排在同一时间，先安排的事件将始终先处理。
